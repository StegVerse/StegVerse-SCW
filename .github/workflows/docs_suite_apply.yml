name: docs-suite-apply
on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]
    paths:
      - "README-HCB.md"
      - ".github/workflows/docs-suite-apply.yml"

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate docs/INDEX.md (compact)
        run: |
          set -euo pipefail
          mkdir -p docs

          SHA_SHORT="$(git rev-parse --short HEAD)"
          DATE_UTC="$(date -u +%Y-%m-%d)"
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          # Basic links (always safe)
          LINKS="- [Root README](./../README.md)"
          if [ -f "README-HCB.md" ]; then
            LINKS="${LINKS}\n- [Hybrid Bridge Playbook (README-HCB.md)](./../README-HCB.md)"
          fi
          if [ -f "hybrid-collab-bridge/README.md" ]; then
            LINKS="${LINKS}\n- [Hybrid Collab Bridge README](./../hybrid-collab-bridge/README.md)"
          fi

          cat > docs/INDEX.md <<'EOFMD'
          # Documentation Index

          This page is auto-generated by **docs-suite-apply**.

          ## Key Docs
          EOFMD

          # Append the links block
          printf "%b\n\n" "${LINKS}" >> docs/INDEX.md

          # Optional: include the first H2 section from README-HCB.md (if present)
          if [ -f "README-HCB.md" ]; then
            echo "## Excerpt: README-HCB.md (first section)" >> docs/INDEX.md
            awk '
              BEGIN{in=0}
              /^## /{ if(in==0){in=1; print; next} else {exit} }
              { if(in==1) print }
            ' README-HCB.md >> docs/INDEX.md || true
            echo "" >> docs/INDEX.md
          fi

          # Footer with version tag
          cat >> docs/INDEX.md <<EOFMD

          ---
          _Auto-generated on **${DATE_UTC}** from \`${SHA_SHORT}\`.  
          Run: ${RUN_URL}_
          EOFMD

      - name: Commit changes (if any)
        run: |
          set -e
          git config user.name "docs-bot"
          git config user.email "bot@stegverse.local"
          if git diff --quiet -- docs/INDEX.md; then
            echo "No changes in docs/INDEX.md"
            exit 0
          fi
          git add docs/INDEX.md
          git commit -m "docs: (auto) generate docs/INDEX.md with links + version tag"
          git push origin HEAD:main

name: reindex-watchdog

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  watchdog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify & dispatch (nudge or autopatch-apply)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name || 'main' }}
        run: |
          set -euo pipefail

          NUDGE_FILE=".github/workflows/reindex-nudge.yml"
          AUTOPATCH_FILE=".github/workflows/autopatch-apply.yml"

          have_nudge=false
          [ -f "$NUDGE_FILE" ] && have_nudge=true

          python - <<'PY'
import os, json, urllib.request, urllib.error, sys
repo   = os.environ["REPO"]
token  = os.environ["GH_TOKEN"]
ref    = os.environ.get("BRANCH") or "main"
have_n = os.environ.get("have_nudge","false").lower()=="true"
headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}

def post(url, payload):
    req = urllib.request.Request(url, data=json.dumps(payload).encode(), method="POST", headers=headers)
    try:
        with urllib.request.urlopen(req) as r:
            r.read()
            return True, None
    except urllib.error.HTTPError as e:
        try:
            err = e.read().decode()
        except Exception:
            err = str(e)
        return False, err

def issue(title, body):
    url = f"https://api.github.com/repos/{repo}/issues"
    post(url, {"title": title, "body": body, "labels": ["reindex-watchdog","ci"]})

if have_n:
    # Dispatch reindex-nudge by filename
    ok, err = post(f"https://api.github.com/repos/{repo}/actions/workflows/reindex-nudge.yml/dispatches",
                   {"ref": ref})
    if ok:
        print("✅ reindex-nudge dispatched.")
        sys.exit(0)
    print("⚠️  Failed to dispatch reindex-nudge:", err or "(no body)")
    # Fall through to open an issue so you see the failure
    issue("Watchdog: failed to dispatch reindex-nudge",
          f"Attempt to dispatch `reindex-nudge.yml` failed on branch `{ref}`.\n\nError:\n```\n{err}\n```")
    sys.exit(1)

# If we get here, nudge is missing — try to dispatch autopatch-apply to heal it.
ok, err = post(f"https://api.github.com/repos/{repo}/actions/workflows/autopatch-apply.yml/dispatches",
               {"ref": ref})
if ok:
    print("🩹 reindex-nudge missing — triggered autopatch-apply to restore it.")
    issue("Watchdog: reindex-nudge missing — triggered AutoPatch",
          "Watchdog detected `.github/workflows/reindex-nudge.yml` was missing and **dispatched `autopatch-apply`** "
          f"on branch `{ref}` to heal it. Check Actions for progress.")
    sys.exit(0)

# As a last resort, just open/refresh an issue.
print("❌ Could not dispatch autopatch-apply:", err or "(no body)")
issue("Watchdog: reindex-nudge missing and autopatch-apply dispatch failed",
      f"`reindex-nudge.yml` is absent and the attempt to dispatch `autopatch-apply.yml` failed on `{ref}`.\n\n"
      f"Error:\n```\n{err}\n```")
sys.exit(1)
PY

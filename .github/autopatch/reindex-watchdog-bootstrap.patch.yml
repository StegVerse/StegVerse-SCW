version: 1
actions:
  - write_files:
      - path: ".github/workflows/reindex-watchdog.yml"
        mode: "100644"
        contents: |
          name: reindex-watchdog
          on:
            workflow_dispatch: {}
            schedule:
              - cron: "0 */6 * * *"
          permissions:
            contents: read
            actions: write
            issues: write
          jobs:
            watchdog:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout
                  uses: actions/checkout@v4
                - name: Verify & optionally dispatch reindex-nudge
                  env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    REPO: ${{ github.repository }}
                    BRANCH: ${{ github.ref_name || 'main' }}
                  run: |
                    set -euo pipefail
                    NUDGE_FILE=".github/workflows/reindex-nudge.yml"
                    if [ ! -f "$NUDGE_FILE" ]; then
                      echo "reindex-nudge workflow missing — raising/refreshing an issue."
                      python - <<'PY'
import os, json, urllib.request, urllib.error
repo = os.environ["REPO"]
token = os.environ["GH_TOKEN"]
headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}
def gh(m,u,d=None):
  r=urllib.request.Request(u,data=(json.dumps(d).encode() if d else None),method=m,headers=headers)
  try:
    with urllib.request.urlopen(r) as R: pass
  except urllib.error.HTTPError as e:
    pass
gh("POST", f"https://api.github.com/repos/{repo}/issues", {
  "title": "Watchdog: reindex-nudge workflow missing",
  "body": "AutoPatch installed the watchdog but reindex-nudge is absent. Run AutoPatch Apply to restore.",
  "labels": ["reindex-watchdog","ci"]
})
PY
                      exit 1
                    fi
                    echo "reindex-nudge.yml found — dispatching."
                    python - <<'PY'
import os, json, urllib.request
repo = os.environ["REPO"]; token=os.environ["GH_TOKEN"]; ref=os.environ.get("BRANCH") or "main"
h={"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}
u=f"https://api.github.com/repos/{repo}/actions/workflows/reindex-nudge.yml/dispatches"
urllib.request.urlopen(urllib.request.Request(u,data=json.dumps({"ref":ref}).encode(),method="POST",headers=h))
print("✅ reindex-nudge dispatched.")
PY

  - commit:
      message: "chore(autopatch): add reindex-watchdog workflow (bootstrap)"

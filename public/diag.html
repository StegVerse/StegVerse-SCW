<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>StegVerse SCW — Diagnostics</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 860px; margin: 24px auto; line-height: 1.45; }
      code { background:#f2f2f2; padding:2px 4px; border-radius:4px; }
      section { border:1px solid #e6e6e6; border-radius:8px; padding:12px; margin-top:18px; }
      button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background:#fafafa }
      input[type="text"], input[type="password"] { width: 100%; padding: 8px; border:1px solid #ddd; border-radius:6px; }
      .row a { margin-right: 12px; }
      .muted { color:#666; }
      pre { background:#f7f7f7; padding:8px; border-radius:6px; white-space:pre-wrap; }
    </style>
  </head>
  <body>
    <h1>StegVerse SCW — Diagnostics</h1>
    <p class="muted">This page calls the API on the same host.</p>

    <section>
      <h3>API Info</h3>
      <div class="row">
        <a href="/healthz" target="_blank">/healthz</a>
        <a href="/whoami" target="_blank">/whoami</a>
        <a href="/v1/ops/health" target="_blank">/v1/ops/health</a>
      </div>
      <button onclick="fetchShow('/v1/ops/env/required','#env')">Check required env</button>
      <button onclick="fetchShow('/v1/ops/metrics','#env')">Metrics</button>
      <pre id="env"></pre>
    </section>

    <section>
      <h3>Run One-Button Supercheck</h3>
      <label>API Base (optional; default = this host)
        <input id="sc_api" type="text" placeholder="https://&lt;your-api&gt;.onrender.com"/>
      </label>
      <label style="display:block;margin-top:8px;">Admin Token (X-Admin-Token)
        <input id="sc_tok" type="password" placeholder="ADMIN_TOKEN"/>
      </label>
      <div style="margin-top:8px;">
        <label><input type="checkbox" id="sc_apply" checked/> Auto-apply safe fixes</label>
        <label style="margin-left:12px;"><input type="checkbox" id="sc_commit"/> Commit directly to main</label>
      </div>
      <button id="sc_btn" style="margin-top:12px;">Run Supercheck</button>
      <pre id="sc_out"></pre>
    </section>

    <script>
      async function fetchShow(path, sel) {
        const el = document.querySelector(sel);
        el.textContent = '…';
        try {
          const res = await fetch(path);
          el.textContent = await res.text();
        } catch (e) {
          el.textContent = 'Error: ' + e.message;
        }
      }

      document.getElementById('sc_btn').onclick = async () => {
        const api_base = document.getElementById('sc_api').value.trim();
        const tok = document.getElementById('sc_tok').value.trim();
        const apply = document.getElementById('sc_apply').checked;
        const commit = document.getElementById('sc_commit').checked;
        const out = document.getElementById('sc_out');
        out.textContent = 'Queuing…';

        try {
          const res = await fetch('/v1/admin/supercheck/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Token': tok },
            body: JSON.stringify({
              api_base: api_base || null,
              auto_apply: apply,
              auto_commit: commit,
              queue_key: 'queue:runs'
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || res.statusText);
          out.textContent =
`✅ Queued workflow: ${data.workflow}
Repo: ${data.repo}

Open GitHub → Actions → One-Button Supercheck → latest run
Artifact: supercheck_bundle → supercheck_report.md`;
        } catch (e) {
          out.textContent = '❌ ' + e.message + '\nTip: ensure ADMIN_TOKEN & GITHUB_* env vars are set on API service.';
        }
      };
    </script>
  </body>
</html>

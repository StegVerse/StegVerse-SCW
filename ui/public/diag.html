<!doctype html>
<meta charset="utf-8"/>
<title>StegVerse Diagnostics & Config</title>
<style>
  body{font-family:system-ui,sans-serif;max-width:980px;margin:32px auto;padding:0 16px}
  .ok{color:#0a0}.bad{color:#b00}.warn{color:#b80}
  pre{background:#f6f8fa;padding:12px;border-radius:8px;white-space:pre-wrap}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text],input[type=password]{width:420px;max-width:100%}
  fieldset{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:16px 0}
  legend{padding:0 6px}
  button{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff}
  small.muted{color:#666}
  label{display:flex;flex-direction:column;gap:4px;margin:6px 0}
</style>

<h1>StegVerse Diagnostics & Config</h1>

<fieldset>
  <legend>Targets</legend>
  <div class="row">
    <label>API base
      <input id="api" type="text" value="https://scw-api.onrender.com">
    </label>
    <label>UI base (informational)
      <input id="ui" type="text" value="https://scw-ui.onrender.com">
    </label>
    <button onclick="run()">Run checks</button>
  </div>
  <pre id="out">Ready.</pre>
</fieldset>

<fieldset id="bootstrapBox" style="display:none">
  <legend>Bootstrap Admin (first-time only)</legend>
  <div class="row">
    <label>New ADMIN_TOKEN
      <input id="bootTok" type="password" placeholder="enter a strong token (min 10 chars)">
    </label>
    <button onclick="bootstrap()">Set Admin Token</button>
  </div>
</fieldset>

<fieldset>
  <legend>Config (requires admin)</legend>
  <div class="row">
    <label>Admin token (X-Admin-Token)
      <input id="adm" type="password" placeholder="enter your ADMIN_TOKEN">
    </label>
    <button onclick="listCfg()">List Config</button>
  </div>
  <div class="row">
    <label>SCW_UI_URL
      <input id="cfg_ui" type="text" value="https://scw-ui.onrender.com">
    </label>
    <label>SCW_API_URL
      <input id="cfg_api" type="text" value="https://scw-api.onrender.com">
    </label>
  </div>
  <div class="row">
    <label>RENDER_UI_DEPLOY_HOOK
      <input id="cfg_rui" type="text" placeholder="https://api.render.com/deploy/srv-...?...">
    </label>
    <label>RENDER_API_DEPLOY_HOOK
      <input id="cfg_rapi" type="text" placeholder="https://api.render.com/deploy/srv-...?...">
    </label>
    <label>RENDER_WORKER_DEPLOY_HOOK
      <input id="cfg_rwrk" type="text" placeholder="(optional)">
    </label>
  </div>
  <div class="row">
    <label>CLOUDFLARE_ZONE_ID
      <input id="cfg_cfz" type="text" placeholder="(optional)">
    </label>
    <label>CLOUDFLARE_API_TOKEN
      <input id="cfg_cft" type="password" placeholder="(optional)">
    </label>
    <label>MIN_REDEPLOY_INTERVAL_S
      <input id="cfg_min" type="text" value="15">
    </label>
  </div>
  <div class="row">
    <button onclick="saveCfg()">Save Config</button>
  </div>
  <pre id="cfgOut"></pre>
</fieldset>

<fieldset>
  <legend>Remediations</legend>
  <div class="row">
    <button onclick="fixCloudflare()">Purge Cloudflare</button>
    <button onclick="fixUiRedeploy()">Redeploy UI</button>
    <button onclick="fixApiRedeploy()">Redeploy API</button>
    <button onclick="fixWorkerRedeploy()">Redeploy Worker</button>
  </div>
  <small class="muted">Enter Admin token above first. After each fix, checks re-run automatically.</small>
</fieldset>

<fieldset>
  <legend>Worker maintenance</legend>
  <div class="row">
    <label><input id="dry" type="checkbox" checked> Dry run (show what would be deleted)</label>
    <label><input id="purgeRuns" type="checkbox" checked> Purge run queues & logs/results</label>
    <button onclick="resetWorker()">Reset Worker State</button>
  </div>
  <small class="muted">Use Dry run first. This clears Redis keys like <code>runs</code> and <code>run:*</code> when enabled.</small>
  <pre id="wrkOut"></pre>
</fieldset>

<fieldset>
  <legend>Cloudflare config</legend>
  <div class="row">
    <label>New Zone ID
      <input id="newZid" type="text" placeholder="e.g. abcdef123456...">
    </label>
    <label>New API Token
      <input id="newTok" type="password" placeholder="token with Cache Purge scope">
    </label>
  </div>
  <div class="row">
    <button onclick="cfSet()">Set/Rotate CF Credentials</button>
    <button onclick="cfReset()">Remove CF Credentials</button>
  </div>
  <small class="muted">After rotating, use Purge Cloudflare above to validate.</small>
  <pre id="cfOut"></pre>
</fieldset>

<script>
const $ = id => document.getElementById(id);
const ok='✅', bad='❌', wrn='⚠️';

async function j(url, opt={}){
  try{
    const r = await fetch(url, opt);
    const t = await r.text();
    let data; try{ data = JSON.parse(t) }catch{ data = t }
    return {ok:r.ok, code:r.status, data};
  }catch(e){ return {ok:false, code:'ERR', data:String(e)} }
}

async function run(){
  const ui=$('ui').value.replace(/\/+$/,'');
  const api=$('api').value.replace(/\/+$/,'');
  const out=$('out'); out.textContent='Running…';
  const bs = await j(api+'/v1/ops/config/bootstrap/status');
  $('bootstrapBox').style.display = (bs.ok && bs.data && bs.data.bootstrap_open) ? '' : 'none';

  const lines=[];
  let u1=await j(ui+'/?v=diag'); lines.push(`${u1.ok?ok:bad} UI reachable (${u1.code})`);
  let u2=await j(ui+'/index.html?v=diag'); lines.push(`${u2.ok?ok:bad} UI /index.html (${u2.code})`);
  let w=await j(api+'/whoami'); lines.push(`${(w.ok && w.data && w.data.service)?ok:bad} API /whoami ${(w.ok? (w.data.service||'?') : w.code)}`);
  let rep=await j(api+'/v1/legal/report/latest'); lines.push(`${rep.ok?ok:(String(rep.data).includes('404')?wrn:bad)} API legal report ${rep.ok?'ok':'(none yet)'}`);
  let al=await j(api+'/v1/legal/alerts'); lines.push(`${(al.ok && Array.isArray(al.data))?ok:bad} API legal alerts ${al.ok?('items='+(Array.isArray(al.data)?al.data.length:'?')):(':: '+al.code)}`);
  out.textContent = lines.join('\n');
}

async function bootstrap(){
  const api=$('api').value.replace(/\/+$/,'');
  const tok=$('bootTok').value.trim();
  if(tok.length<10){ alert('Please enter a stronger ADMIN_TOKEN (>= 10 chars).'); return; }
  const r=await j(api+'/v1/ops/config/bootstrap', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ADMIN_TOKEN: tok})});
  alert((r.ok?'OK ':'ERR ')+JSON.stringify(r.data).slice(0,300));
  if(r.ok){ $('adm').value = tok; run(); }
}

async function listCfg(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/config/list', {headers:{'X-Admin-Token':adm}});
  $('cfgOut').textContent = (r.ok? JSON.stringify(r.data,null,2) : ('ERR '+r.code+' '+JSON.stringify(r.data)));
}

async function saveCfg(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const payload={
    SCW_UI_URL: $('cfg_ui').value.trim(),
    SCW_API_URL: $('cfg_api').value.trim(),
    RENDER_UI_DEPLOY_HOOK: $('cfg_rui').value.trim(),
    RENDER_API_DEPLOY_HOOK: $('cfg_rapi').value.trim(),
    RENDER_WORKER_DEPLOY_HOOK: $('cfg_rwrk').value.trim(),
    CLOUDFLARE_ZONE_ID: $('cfg_cfz').value.trim(),
    CLOUDFLARE_API_TOKEN: $('cfg_cft').value.trim(),
    MIN_REDEPLOY_INTERVAL_S: $('cfg_min').value.trim()
  };
  const r=await j(api+'/v1/ops/config/set', {method:'POST', headers:{'Content-Type':'application/json','X-Admin-Token':adm}, body: JSON.stringify(payload)});
  $('cfgOut').textContent = (r.ok? JSON.stringify(r.data,null,2) : ('ERR '+r.code+' '+JSON.stringify(r.data)));
  if(r.ok) setTimeout(run, 1500);
}

async function fixCloudflare(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/purge/cloudflare', {method:'POST', headers:{'X-Admin-Token':adm}});
  alert((r.ok?'OK ':'ERR ')+JSON.stringify(r.data).slice(0,300));
  setTimeout(run, 4000);
}
async function fixUiRedeploy(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/redeploy/ui', {method:'POST', headers:{'X-Admin-Token':adm}});
  alert((r.ok?'OK ':'ERR ')+JSON.stringify(r.data).slice(0,300));
  setTimeout(run, 5000);
}
async function fixApiRedeploy(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/redeploy/api', {method:'POST', headers:{'X-Admin-Token':adm}});
  alert((r.ok?'OK ':'ERR ')+JSON.stringify(r.data).slice(0,300));
  setTimeout(run, 5000);
}
async function fixWorkerRedeploy(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/redeploy/worker', {method:'POST', headers:{'X-Admin-Token':adm}});
  alert((r.ok?'OK ':'ERR ')+JSON.stringify(r.data).slice(0,300));
  setTimeout(run, 5000);
}

async function resetWorker(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const dry=$('dry').checked;
  const purgeRuns=$('purgeRuns').checked;
  const r=await j(api+'/v1/ops/worker/reset', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Admin-Token':adm},
    body: JSON.stringify({dry_run: dry, purge_runs: purgeRuns})
  });
  $('wrkOut').textContent = (r.ok? JSON.stringify(r.data,null,2) : ('ERR '+r.code+' '+JSON.stringify(r.data)));
}

async function cfSet(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const zid=$('newZid').value.trim();
  const tok=$('newTok').value.trim();
  if(!zid && !tok){ alert('Enter a Zone ID and/or API token to set/rotate.'); return; }
  const r=await j(api+'/v1/ops/config/cloudflare/set', {
    method:'POST', headers:{'Content-Type':'application/json','X-Admin-Token':adm},
    body: JSON.stringify({CLOUDFLARE_ZONE_ID:zid, CLOUDFLARE_API_TOKEN:tok})
  });
  $('cfOut').textContent = (r.ok? JSON.stringify(r.data,null,2) : ('ERR '+r.code+' '+JSON.stringify(r.data)));
}
async function cfReset(){
  const api=$('api').value.replace(/\/+$/,'');
  const adm=$('adm').value.trim();
  const r=await j(api+'/v1/ops/config/cloudflare/reset', {method:'POST', headers:{'X-Admin-Token':adm}});
  $('cfOut').textContent = (r.ok? JSON.stringify(r.data,null,2) : ('ERR '+r.code+' '+JSON.stringify(r.data)));
}
</script>

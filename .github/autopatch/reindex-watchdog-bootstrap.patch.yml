version: 1
actions:
  - write_files:
      - path: ".github/workflows/reindex-watchdog.yml"
        mode: "100644"
        contents: |
          name: reindex-watchdog
          on:
            workflow_dispatch: {}
            schedule:
              - cron: "0 */6 * * *"
          permissions:
            contents: read
            actions: write
            issues: write
          jobs:
            watchdog:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout
                  uses: actions/checkout@v4
                - name: Verify & dispatch (nudge or autopatch-apply)
                  env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    REPO: ${{ github.repository }}
                    BRANCH: ${{ github.ref_name || 'main' }}
                  run: |
                    set -euo pipefail
                    NUDGE_FILE=".github/workflows/reindex-nudge.yml"
                    [ -f "$NUDGE_FILE" ] && have_nudge=true || have_nudge=false
                    python - <<'PY'
import os, json, urllib.request, urllib.error, sys
repo   = os.environ["REPO"]
token  = os.environ["GH_TOKEN"]
ref    = os.environ.get("BRANCH") or "main"
have_n = os.environ.get("have_nudge","false").lower()=="true"
headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}
def post(url,payload):
  req=urllib.request.Request(url,data=json.dumps(payload).encode(),method="POST",headers=headers)
  try:
    urllib.request.urlopen(req).read(); return True,None
  except urllib.error.HTTPError as e:
    try: return False,e.read().decode()
    except: return False,str(e)
def issue(t,b):
  post(f"https://api.github.com/repos/{repo}/issues",{"title":t,"body":b,"labels":["reindex-watchdog","ci"]})
if have_n:
  ok,err=post(f"https://api.github.com/repos/{repo}/actions/workflows/reindex-nudge.yml/dispatches",{"ref":ref})
  if ok: print("âœ… reindex-nudge dispatched."); sys.exit(0)
  print("âš ï¸  Failed to dispatch reindex-nudge:",err); issue("Watchdog: failed to dispatch reindex-nudge",f"Err:\n```\n{err}\n```"); sys.exit(1)
ok,err=post(f"https://api.github.com/repos/{repo}/actions/workflows/autopatch-apply.yml/dispatches",{"ref":ref})
if ok:
  print("ðŸ©¹ reindex-nudge missing â€” triggered autopatch-apply.")
  issue("Watchdog: reindex-nudge missing â€” triggered AutoPatch",
        f"Dispatched `autopatch-apply.yml` on `{ref}` to restore the nudge.")
  sys.exit(0)
print("âŒ autopatch-apply dispatch failed:",err); issue("Watchdog: nudge missing & autopatch-apply failed",f"Err:\n```\n{err}\n```"); sys.exit(1)
PY
  - commit:
      message: "chore(autopatch): add self-healing reindex-watchdog (auto-dispatch autopatch-apply)"

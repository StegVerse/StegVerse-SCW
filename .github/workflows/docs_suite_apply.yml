name: docs-suite-apply

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]
    paths:
      - ".github/autopatch/docs-suite.patch.yml"

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Generate docs/INDEX.md (compact)
        run: |
          set -euo pipefail
          mkdir -p docs
          cat > docs/INDEX.md <<'EOF'
          # StegVerse Documentation

          ## Hybrid Collab Bridge (HCB)
          - **Repo path:** `hybrid-collab-bridge/`
          - **API health:** `GET /health`
          - **Run collaboration:** `POST /v1/run`
          - **Continue/finalize:** `POST /v1/continue`

          ### Quickstart (local)
          ```bash
          cd hybrid-collab-bridge
          cp .env.example .env   # fill ADMIN_TOKEN and ANTHROPIC_API_KEY (when not using mock)
          cd api
          pip install -r requirements.txt
          uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload
          ```

          ### CI Notes
          - CI uses a **mock provider** config at `hybrid-collab-bridge/providers.ci.yaml`
          - Functional smoke runs `/health` and a sample `/v1/run` with `human_gate: true`

          ---
          _Autogenerated by docs-suite-apply._
          EOF

      - name: Commit changes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "one-shot-patch-bot"
          git config user.email "bot@stegverse.local"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: (auto) generate docs/INDEX.md"
            git push origin HEAD:main
          fi

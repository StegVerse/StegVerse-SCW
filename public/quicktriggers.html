<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StegVerse Quick Triggers</title>
<style>
  :root {
    --bg:#0f1115; --card:#141821; --text:#e7ecf3; --muted:#9aa4b2; --accent:#3ea6ff; --ok:#23d18b; --bad:#ff5f56;
  }
  html,body{background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif;margin:0}
  .wrap{max-width:920px;margin:24px auto;padding:0 16px}
  h1{font-weight:700;font-size:1.6rem;margin:8px 0 4px}
  p.lead{color:var(--muted);margin:0 0 18px}
  .repo{background:var(--card);border-radius:14px;padding:16px 14px;margin:14px 0;box-shadow:0 2px 14px rgba(0,0,0,.25)}
  .repo h2{font-size:1.1rem;margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}
  .primary{background:#111827;color:#fff;border:1px solid #222c3a}
  .primary:hover{background:#0c1320}
  .accent{background:var(--accent);color:#04121f}
  .ghost{background:transparent;border:1px solid #2a3242;color:var(--text)}
  .tag{font-size:.85rem;border:1px solid #2a3242;border-radius:8px;padding:4px 8px;color:var(--muted)}
  .status{margin-top:8px;border-top:1px dashed #253042;padding-top:8px;color:var(--muted);font-size:.95rem}
  .status ul{margin:6px 0 0 18px;padding:0}
  .status li{margin:2px 0}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .wait{color:#e0c66c}
  .hint{font-size:.9rem;color:var(--muted);margin-top:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .footer{color:#718096;font-size:.85rem;margin:24px 0 12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>StegVerse Quick Triggers</h1>
  <p class="lead">Tap a trigger to open the GitHub edit screen for the trigger file. <b>Commit changes</b> to fire the workflow.
    Latest results (last two runs) are shown below each trigger.</p>

  <div id="mount"></div>

  <div class="footer">No tokens used. API results cached in your browser for 2 minutes to avoid rate limits.</div>
</div>

<script>
/** ======== CONFIG (edit me) ======== **/
const OWNER = "StegVerse";
const REPO  = "StegVerse-SCW";

// Each entry renders one card on the page.
const WORKFLOWS = [
  {
    label: "Supercheck",
    workflowFile: ".github/workflows/one_button_supercheck.yml",
    triggerPath:  ".github/trigger/supercheck/run-%F0%9F%9A%80.txt", // URL-encoded üöÄ
    triggerContent: "go\n",
    viewRunsUrl: `https://github.com/${OWNER}/${REPO}/actions/workflows/one_button_supercheck.yml`,
    triggerFolderUrl: `https://github.com/${OWNER}/${REPO}/tree/main/.github/trigger/supercheck`
  },
  {
    label: "Preflight",
    workflowFile: ".github/workflows/workflow_preflight.yml",
    triggerPath:  ".github/trigger/preflight/run-1.txt",
    triggerContent: "go\n",
    viewRunsUrl: `https://github.com/${OWNER}/${REPO}/actions/workflows/workflow_preflight.yml`,
    triggerFolderUrl: `https://github.com/${OWNER}/${REPO}/tree/main/.github/trigger/preflight`
  },
  {
    label: "Rebuild Kit",
    workflowFile: ".github/workflows/rebuild_kit.yml",
    triggerPath:  ".github/trigger/rebuild/run-1.txt",
    triggerContent: "go\n",
    viewRunsUrl: `https://github.com/${OWNER}/${REPO}/actions/workflows/rebuild_kit.yml`,
    triggerFolderUrl: `https://github.com/${OWNER}/${REPO}/tree/main/.github/trigger/rebuild`
  }
];

// GitHub ‚Äúnew file‚Äù URL helper (prefill path + body)
function editNewFileUrl(path, content, message="trigger: run") {
  // For ‚Äúcreate new file‚Äù with preset path we use /new/<branch>?filename=‚Ä¶&value=‚Ä¶
  const base = `https://github.com/${OWNER}/${REPO}/new/main`;
  const params = new URLSearchParams({
    filename: path,
    value: content,
    message
  });
  return `${base}?${params.toString()}`;
}

/** ======== RENDER ======== **/
const el = (t, props={}, ...kids) => {
  const n = document.createElement(t);
  Object.entries(props).forEach(([k,v])=>{
    if (k === "class") n.className = v;
    else if (k.startsWith("on")) n.addEventListener(k.slice(2).toLowerCase(), v);
    else if (k === "href") n.setAttribute("href", v);
    else n[k]=v;
  });
  kids.forEach(k => n.append(k));
  return n;
};

function render() {
  const mount = document.getElementById("mount");
  mount.innerHTML = "";
  // Repo header
  mount.append(
    el("div", {class:"repo"},
      el("h2", {}, `${OWNER}/${REPO}`),
      el("div", {class:"hint"}, "Open trigger file ‚Üí Commit to run (GitHub will ask you to log in if needed).")
    )
  );

  WORKFLOWS.forEach(w => {
    const card = el("div", {class:"repo"});
    card.append(el("h2", {}, w.label));

    const triggerHref = editNewFileUrl(w.triggerPath, w.triggerContent, `chore(trigger): ${w.label.toLowerCase()}`);
    const row = el("div", {class:"row"},
      el("a", {class:"btn primary", href: triggerHref, target:"_blank"},
        "Open trigger file ‚Üí Commit to run"),
      el("a", {class:"btn accent", href: w.viewRunsUrl, target:"_blank"}, "View Runs"),
      el("a", {class:"btn ghost", href: w.triggerFolderUrl, target:"_blank"}, "Open Trigger Folder"),
      el("span", {class:"tag mono"}, w.workflowFile)
    );
    card.append(row);

    const status = el("div", {class:"status"}, "Fetching recent runs‚Ä¶");
    card.append(status);
    mount.append(card);

    // Fill last-two status
    fetchLastTwoRuns(OWNER, REPO, w.workflowFile).then(data=>{
      status.innerHTML = formatRunsHtml(data);
    }).catch(err=>{
      status.innerHTML = `<span class="bad">Couldn‚Äôt load runs</span> <span class="mono">${err.message}</span>`;
    });
  });
}

/** ======== DATA (no token) ======== **/
const CACHE_TTL_MS = 120000; // 2 minutes
function cacheKey(f){ return `runs:${OWNER}/${REPO}:${f}`; }

async function fetchLastTwoRuns(owner, repo, workflowPath) {
  const key = cacheKey(workflowPath);
  const now = Date.now();
  const cached = localStorage.getItem(key);
  if (cached) {
    try {
      const obj = JSON.parse(cached);
      if (obj.t + CACHE_TTL_MS > now) return obj.d;
    } catch {}
  }

  // GitHub API endpoint for runs of a workflow by file name
  const api = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${encodeURIComponent(workflowPath)}/runs?per_page=2`;
  const r = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  const d = (j.workflow_runs || []).slice(0,2).map(x => ({
    status: x.conclusion || x.status, // completed|success|failure|queued|in_progress
    when:   x.run_started_at || x.created_at,
    html_url: x.html_url
  }));
  localStorage.setItem(key, JSON.stringify({t: now, d}));
  return d;
}

function fmtWhen(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString([], {hour12:false});
  } catch { return iso || ""; }
}

function emoji(status) {
  if (!status) return "‚è≥";
  const s = status.toLowerCase();
  if (s.includes("success")) return "‚úÖ";
  if (s.includes("failure") || s.includes("cancel")) return "‚ùå";
  if (s.includes("queued") || s.includes("in_progress")) return "‚è≥";
  return "‚ÑπÔ∏è";
}

function klass(status){
  if (!status) return "wait";
  const s = status.toLowerCase();
  if (s.includes("success")) return "ok";
  if (s.includes("failure") || s.includes("cancel")) return "bad";
  return "wait";
}

function formatRunsHtml(runs) {
  if (!runs || runs.length === 0) return "(no history yet)";
  const lis = runs.map(r =>
    `<li class="${klass(r.status)}">${emoji(r.status)} <a href="${r.html_url}" target="_blank">run</a> ‚Äî <span class="mono">${(r.status||'').replaceAll('_',' ')}</span> ¬∑ <span class="mono">${fmtWhen(r.when)}</span></li>`
  ).join("");
  return `<ul>${lis}</ul>`;
}

render();
</script>
</body>
</html>
